// Name of the executable with probes. SystemTap requires that this either be an
// absolute path, or something that can be found in $PATH.
@define BITCOIND
%(
  "bitcoind"
%)

probe bitcoin = process(@BITCOIND) {}

probe bitcoin.init_main = process(@BITCOIND).mark("init_main") {
  datadir = user_string($arg1)
  config = user_string($arg2)
}

probe bitcoin.coin_cache_flush = process(@BITCOIND).mark("coin_cache_flush") {
  coins = $arg1
  bytes = $arg2
}

probe bitcoin.coin_cache_fetch = process(@BITCOIND).mark("coin_cache_fetch") {
  hit = $arg1  // 1 for cache hit, 0 for cache miss
}

probe bitcoin.finish_ibd = process(@BITCOIND).mark("finish_ibd") {}

probe bitcoin.read_block_from_disk = process(@BITCOIND).mark("read_block_from_disk") {
  height = $arg1
  filenum = $arg2
}

probe bitcoin.update_tip = process(@BITCOIND).mark("update_tip") {
  block = user_string($arg1)
  height = $arg2
  cache_size = $arg3
  cache_bytes = $arg4
  progress = $arg5
}

probe bitcoin.db_batch_write = process(@BITCOIND).mark("db_batch_write") {
  dbname = user_string($arg1)
  size_estimate = $arg2
  put_count = $arg3
  erase_count = $arg4
}

// Probe the LevelDB table cache to check for hit or miss
probe bitcoin.leveldb_table_cache = process(@BITCOIND).function("leveldb::TableCache::FindTable").return {
  hit = $return->state_ ? 1 : 0
}

// LevelDB background compaction
probe leveldb.compaction = process(@BITCOIND).function("leveldb::DBImpl::BackgroundCompaction") {}

// LevelDB Get
probe leveldb.get = process(@BITCOIND).function("leveldb::DBImpl::Get") {}

// LevelDB Put
probe leveldb.put = process(@BITCOIND).function("leveldb::DBImpl::Put") {}

// LevelDB Write
probe leveldb.write = process(@BITCOIND).function("leveldb::DBImpl::Write") {}

// LevelDB Delete
probe leveldb.delete = process(@BITCOIND).function("leveldb::DBImpl::Delete") {}

// Called during WAL application
probe leveldb.log_and_apply = process(@BITCOIND).function("leveldb::VersionSet::LogAndApply") {}

probe ldb_posix.new_appendable_file = process(@BITCOIND).function("NewAppendableFile@leveldb/util/env_posix.cc:397") {
  name = "NewAppendableFile"
}

probe ldb_posix.new_random_access_file = process(@BITCOIND).function("NewRandomAccessFile@leveldb/util/env_posix.cc:356") {
  name = "NewRandomAccessFile"
}

probe ldb_posix.new_writable_file = process(@BITCOIND).function("NewWritableFile@leveldb/util/env_posix.cc:384") {
  name = "NewWritableFile"
}

probe ldb_posix.new_sequential_file = process(@BITCOIND).function("NewSequentialFile@leveldb/util/env_posix.cc:344") {
  name = "NewSequentialFile"
}

// PosixEnv::DeleteFile
probe ldb_posix.delete_file = process(@BITCOIND).function("DeleteFile@leveldb/util/env_posix.cc:429") {
  name = "DeleteFile"
}
